<!-- /index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>My Photo Progress Story</title>
    <meta
      name="description"
      content="An interactive photo story: upload photos, add captions, and track progress over time."
    />
    <style>
      /* Minimal, readable styles (no frameworks) */
      :root {
        --bg: #0f1115;
        --panel: #171923;
        --muted: #a0aec0;
        --text: #e6edf3;
        --brand: #5b9cff;
        --ring: rgba(91, 156, 255, 0.45);
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        background: linear-gradient(180deg, #0d0f14, #0b0d12 60%, #0a0c10);
        color: var(--text);
      }
      a { color: var(--brand); text-decoration: none; }
      header {
        position: sticky; top: 0; z-index: 10;
        backdrop-filter: saturate(1.2) blur(10px);
        background: linear-gradient(180deg, rgba(10,12,16,0.85), rgba(10,12,16,0.35));
        border-bottom: 1px solid #1f2330;
      }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 18px 16px; }
      .row {
        display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
        justify-content: space-between;
      }
      .brand { font-weight: 700; letter-spacing: .2px; }
      .controls { display: flex; gap: 10px; flex-wrap: wrap; }
      .btn {
        border: 1px solid #2b3245; background: #151a23; color: var(--text);
        padding: 10px 14px; border-radius: 10px; cursor: pointer;
        transition: transform .05s ease, border .2s ease, background .2s ease;
      }
      .btn:hover { border-color: #3a435c; background: #171e29; }
      .btn:active { transform: translateY(1px); }
      input[type="file"] { display: none; }
      .tag {
        padding: 6px 10px; border: 1px solid #2b3245; border-radius: 999px;
        background: #141823; color: var(--muted); cursor: pointer;
      }
      .search {
        min-width: 220px; border: 1px solid #2b3245; background: #141823; color: var(--text);
        border-radius: 10px; padding: 10px 12px; outline: none;
      }
      main { padding: 18px 16px 80px; }
      .empty {
        border: 1px dashed #2b3245; border-radius: 14px; padding: 30px; text-align: center;
        background: #0f1320;
      }
      .dropzone {
        margin-top: 14px; padding: 30px; border: 2px dashed #2b3245; border-radius: 14px;
        background: #0e1220;
      }
      .grid {
        display: grid; gap: 12px; margin-top: 18px;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }
      .card {
        border: 1px solid #1f2330; border-radius: 12px; overflow: hidden; background: #0f131d;
      }
      .card img { width: 100%; height: 220px; object-fit: cover; display: block; }
      .card .meta { padding: 10px 12px; display: grid; gap: 6px; }
      .meta .title { font-weight: 600; }
      .muted { color: var(--muted); font-size: .92rem; }
      .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #14192a; border: 1px solid #26314b; font-size: .8rem; color: #bac8e6; }

      .toolbar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
      .switch { display: inline-flex; gap: 6px; border: 1px solid #2b3245; border-radius: 999px; padding: 4px; background: #141823; }
      .switch button { padding: 8px 12px; border: 0; background: transparent; color: var(--muted); border-radius: 999px; cursor: pointer; }
      .switch button.active { background: #0f1726; color: var(--text); border: 1px solid #3a435c; }

      .timeline { margin-top: 22px; }
      .t-item {
        display: grid; grid-template-columns: 80px 1fr; gap: 14px; padding: 14px 8px; border-bottom: 1px solid #1a1f2c;
      }
      .t-dot { width: 12px; height: 12px; border-radius: 999px; background: var(--brand); box-shadow: 0 0 0 6px rgba(91,156,255,0.12); margin-top: 6px; }
      .t-date { color: #b8c4df; font-size: .9rem; }
      .t-body { display: grid; gap: 8px; }
      .t-img { border: 1px solid #26314b; border-radius: 12px; overflow: hidden; background: #0f131d; }
      .t-img img { width: 100%; height: 320px; object-fit: cover; display: block; }

      /* Lightbox */
      .lightbox {
        position: fixed; inset: 0; background: rgba(0,0,0,.85);
        display: none; align-items: center; justify-content: center; padding: 16px;
      }
      .lightbox.open { display: flex; }
      .lb-wrap { max-width: 95vw; max-height: 90vh; display: grid; gap: 12px; }
      .lb-img { max-height: 70vh; border-radius: 12px; overflow: hidden; border: 1px solid #2b3245; }
      .lb-img img { display: block; max-width: 100%; max-height: 70vh; object-fit: contain; width: auto; height: auto; }
      .lb-meta { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
      .lb-left { display: grid; gap: 4px; }
      .lb-title { font-weight: 700; }
      .lb-caption { color: var(--muted); }
      .lb-controls { display: flex; gap: 8px; }
      .x { position: absolute; top: 12px; right: 12px; cursor: pointer; padding: 10px 12px; background: #151a23; border: 1px solid #2b3245; border-radius: 10px; }

      /* Small helpers */
      .srch { flex: 1 1 280px; }
      .hidden { display: none; }
      .hint { font-size: .9rem; color: var(--muted); }
      footer { text-align: center; color: var(--muted); padding: 30px 10px; }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <div class="row">
          <div class="brand">üì∏ My Photo Progress</div>
          <div class="controls">
            <label class="btn" for="file-input">Add Photos</label>
            <input id="file-input" type="file" accept="image/*" multiple />
            <button id="export-btn" class="btn">Export JSON</button>
            <label class="btn" for="import-input">Import JSON</label>
            <input id="import-input" type="file" accept="application/json" />
          </div>
        </div>
        <div class="toolbar">
          <div class="switch" role="tablist" aria-label="View mode">
            <button id="tab-gallery" class="active" data-tab="gallery">Gallery</button>
            <button id="tab-timeline" data-tab="timeline">Timeline</button>
          </div>
          <input id="search" class="search srch" placeholder="Search title/caption/tags‚Ä¶" />
          <select id="year-filter" class="search" style="min-width:120px">
            <option value="">All years</option>
          </select>
          <select id="sort" class="search" style="min-width:140px">
            <option value="new">Newest first</option>
            <option value="old">Oldest first</option>
          </select>
        </div>
      </div>
    </header>

    <main class="wrap">
      <section id="empty" class="empty">
        <h2>Start your story</h2>
        <p class="hint">Upload a few photos to begin. You can add titles, captions, dates, and tags.</p>
        <div id="dropzone" class="dropzone">Drop images here</div>
      </section>

      <section id="gallery" class="hidden">
        <div id="grid" class="grid"></div>
      </section>

      <section id="timeline" class="hidden">
        <div id="time-list" class="timeline"></div>
      </section>
    </main>

    <div id="lightbox" class="lightbox" aria-modal="true" role="dialog">
      <div class="lb-wrap">
        <div class="lb-img"><img id="lb-img" alt="Preview"/></div>
        <div class="lb-meta">
          <div class="lb-left">
            <div class="lb-title" id="lb-title"></div>
            <div class="lb-caption" id="lb-caption"></div>
            <div class="muted" id="lb-date"></div>
            <div id="lb-tags"></div>
          </div>
          <div class="lb-controls">
            <button id="prev" class="btn" title="Prev (‚Üê)">‚Üê</button>
            <button id="next" class="btn" title="Next (‚Üí)">‚Üí</button>
            <button id="edit" class="btn">Edit</button>
            <button id="del" class="btn">Delete</button>
          </div>
        </div>
      </div>
      <button class="x" id="close">‚úï</button>
    </div>

    <footer>
      Hosted on GitHub Pages ‚Ä¢ Your data is stored locally in your browser (Export JSON to back up).
    </footer>

    <script>
      // --- Data & persistence ---
      const KEY = "ps_photos_v1";
      /** why: stable ids across reloads */
      const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

      /** @type {Array<{id:string,title:string,caption:string,dateISO:string,tags:string[],src:string}>} */
      let items = [];

      const persist = () => localStorage.setItem(KEY, JSON.stringify(items));
      const hydrate = () => {
        try {
          const raw = localStorage.getItem(KEY);
          items = raw ? JSON.parse(raw) : [];
        } catch {
          items = [];
        }
      };

      // --- State ---
      let view = "gallery"; // or "timeline"
      let q = ""; // search
      let year = ""; // filter
      let sort = "new"; // new | old
      let currentIndex = -1; // lightbox

      // --- DOM refs ---
      const els = {
        empty: document.getElementById("empty"),
        gallery: document.getElementById("gallery"),
        grid: document.getElementById("grid"),
        timeline: document.getElementById("timeline"),
        timeList: document.getElementById("time-list"),
        search: document.getElementById("search"),
        year: document.getElementById("year-filter"),
        sort: document.getElementById("sort"),
        tabGal: document.getElementById("tab-gallery"),
        tabTime: document.getElementById("tab-timeline"),
        file: document.getElementById("file-input"),
        import: document.getElementById("import-input"),
        export: document.getElementById("export-btn"),
        drop: document.getElementById("dropzone"),
        lb: document.getElementById("lightbox"),
        lbImg: document.getElementById("lb-img"),
        lbTitle: document.getElementById("lb-title"),
        lbCaption: document.getElementById("lb-caption"),
        lbDate: document.getElementById("lb-date"),
        lbTags: document.getElementById("lb-tags"),
        lbClose: document.getElementById("close"),
        prev: document.getElementById("prev"),
        next: document.getElementById("next"),
        edit: document.getElementById("edit"),
        del: document.getElementById("del"),
      };

      // --- Utilities ---
      const byDate = (a, b) => new Date(a.dateISO) - new Date(b.dateISO);
      const fmt = (iso) => {
        if (!iso) return "";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso;
        return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      };
      const unique = (arr) => [...new Set(arr)];

      function filtered() {
        let out = items
          .filter((it) =>
            !q
              ? true
              : (it.title + " " + it.caption + " " + (it.tags || []).join(" "))
                  .toLowerCase()
                  .includes(q.toLowerCase())
          )
          .filter((it) => (year ? (it.dateISO || "").startsWith(year) : true));
        out.sort(byDate);
        if (sort === "new") out.reverse();
        return out;
      }

      function years() {
        return unique(
          items
            .map((it) => (it.dateISO || "").slice(0, 4))
            .filter(Boolean)
            .sort()
        );
      }

      // --- Rendering ---
      function render() {
        const data = filtered();

        // empty state
        const has = data.length > 0;
        els.empty.classList.toggle("hidden", has);
        document.getElementById("gallery").classList.toggle("hidden", !has || view !== "gallery");
        document.getElementById("timeline").classList.toggle("hidden", !has || view !== "timeline");

        // filter year options
        const ys = years();
        els.year.innerHTML = `<option value="">All years</option>${ys
          .map((y) => `<option value="${y}" ${y === year ? "selected" : ""}>${y}</option>`)
          .join("")}`;

        // gallery
        if (view === "gallery") {
          els.grid.innerHTML = data
            .map(
              (it, i) => `
            <article class="card" data-idx="${i}">
              <img src="${it.src}" alt="${it.title || "Photo"}" loading="lazy" />
              <div class="meta">
                <div class="title">${escapeHtml(it.title || "Untitled")}</div>
                <div class="muted">${fmt(it.dateISO)}</div>
                <div>${(it.tags || [])
                  .slice(0, 3)
                  .map((t) => `<span class="pill">${escapeHtml(t)}</span>`)
                  .join(" ")}</div>
              </div>
            </article>`
            )
            .join("");
          // bind clicks
          [...els.grid.querySelectorAll(".card")].forEach((card) =>
            card.addEventListener("click", () => openLightbox(parseInt(card.dataset.idx, 10)))
          );
        }

        // timeline
        if (view === "timeline") {
          els.timeList.innerHTML = data
            .map(
              (it, i) => `
              <div class="t-item" data-idx="${i}">
                <div>
                  <div class="t-dot"></div>
                </div>
                <div class="t-body">
                  <div class="t-date">${fmt(it.dateISO)}</div>
                  <div class="t-img"><img src="${it.src}" alt="${it.title || "Photo"}" loading="lazy"/></div>
                  <div class="title">${escapeHtml(it.title || "Untitled")}</div>
                  <div class="muted">${escapeHtml(it.caption || "")}</div>
                  <div>${(it.tags || []).map((t) => `<span class="pill">${escapeHtml(t)}</span>`).join(" ")}</div>
                </div>
              </div>`
            )
            .join("");
          [...els.timeList.querySelectorAll(".t-item")].forEach((row) =>
            row.addEventListener("click", () => openLightbox(parseInt(row.dataset.idx, 10)))
          );
        }
      }

      // --- Lightbox ---
      function openLightbox(filteredIndex) {
        const data = filtered();
        currentIndex = filteredIndex;
        const it = data[currentIndex];
        if (!it) return;
        els.lbImg.src = it.src;
        els.lbTitle.textContent = it.title || "Untitled";
        els.lbCaption.textContent = it.caption || "";
        els.lbDate.textContent = fmt(it.dateISO);
        els.lbTags.innerHTML = (it.tags || []).map((t) => `<span class="pill">${escapeHtml(t)}</span>`).join(" ");
        els.lb.classList.add("open");
      }
      function closeLightbox() {
        els.lb.classList.remove("open");
        currentIndex = -1;
      }
      function move(dir) {
        const data = filtered();
        if (!data.length) return;
        currentIndex = (currentIndex + dir + data.length) % data.length;
        openLightbox(currentIndex);
      }

      // --- Import/Export ---
      function exportJson() {
        const blob = new Blob([JSON.stringify(items, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "photo-story.json";
        a.click();
        URL.revokeObjectURL(a.href);
      }
      function importJson(file) {
        const fr = new FileReader();
        fr.onload = () => {
          try {
            const arr = JSON.parse(fr.result);
            if (!Array.isArray(arr)) throw new Error("Invalid JSON");
            items = arr;
            persist();
            render();
          } catch (e) {
            alert("Import failed: " + e.message);
          }
        };
        fr.readAsText(file);
      }

      // --- Editing (simple prompt-based to keep single-file minimal) ---
      function editCurrent() {
        const data = filtered();
        const it = data[currentIndex];
        if (!it) return;
        const idx = items.findIndex((x) => x.id === it.id);
        const title = prompt("Title:", it.title || "") ?? it.title;
        const caption = prompt("Caption:", it.caption || "") ?? it.caption;
        const dateISO = prompt("Date (YYYY-MM-DD):", (it.dateISO || "").slice(0, 10)) ?? it.dateISO;
        const tagsStr = prompt("Tags (comma-separated):", (it.tags || []).join(", ")) ?? (it.tags || []).join(", ");
        const tags = tagsStr.split(",").map((s) => s.trim()).filter(Boolean);
        items[idx] = { ...items[idx], title, caption, dateISO, tags };
        persist();
        render();
        openLightbox(filtered().findIndex((x) => x.id === it.id));
      }

      function deleteCurrent() {
        const data = filtered();
        const it = data[currentIndex];
        if (!it) return;
        if (!confirm("Delete this photo?")) return;
        items = items.filter((x) => x.id !== it.id);
        persist();
        closeLightbox();
        render();
      }

      // --- File handling ---
      function addFiles(fileList) {
        const files = [...fileList].filter((f) => f.type.startsWith("image/"));
        if (!files.length) return;
        let processed = 0;
        files.forEach((file) => {
          const fr = new FileReader();
          fr.onload = () => {
            const obj = {
              id: uid(),
              title: file.name.replace(/\.[^.]+$/, "").replace(/[_\-]+/g, " "),
              caption: "",
              dateISO: new Date().toISOString(),
              tags: [],
              src: fr.result,
            };
            items.push(obj);
            processed++;
            if (processed === files.length) {
              persist();
              render();
            }
          };
          fr.readAsDataURL(file);
        });
      }

      // --- Events ---
      function bind() {
        els.tabGal.addEventListener("click", () => {
          view = "gallery";
          els.tabGal.classList.add("active");
          els.tabTime.classList.remove("active");
          render();
        });
        els.tabTime.addEventListener("click", () => {
          view = "timeline";
          els.tabTime.classList.add("active");
          els.tabGal.classList.remove("active");
          render();
        });

        els.search.addEventListener("input", (e) => { q = e.target.value; render(); });
        els.year.addEventListener("change", (e) => { year = e.target.value; render(); });
        els.sort.addEventListener("change", (e) => { sort = e.target.value; render(); });

        els.file.addEventListener("change", (e) => addFiles(e.target.files));
        els.drop.addEventListener("dragover", (e) => { e.preventDefault(); els.drop.style.borderColor = "var(--ring)"; });
        els.drop.addEventListener("dragleave", () => { els.drop.style.borderColor = "#2b3245"; });
        els.drop.addEventListener("drop", (e) => { e.preventDefault(); els.drop.style.borderColor = "#2b3245"; addFiles(e.dataTransfer.files); });

        els.export.addEventListener("click", exportJson);
        els.import.addEventListener("change", (e) => {
          const [file] = e.target.files || [];
          if (file) importJson(file);
          e.target.value = "";
        });

        // Lightbox
        els.lbClose.addEventListener("click", closeLightbox);
        els.prev.addEventListener("click", () => move(-1));
        els.next.addEventListener("click", () => move(1));
        els.edit.addEventListener("click", editCurrent);
        els.del.addEventListener("click", deleteCurrent);
        document.addEventListener("keydown", (e) => {
          if (!document.getElementById("lightbox").classList.contains("open")) return;
          if (e.key === "Escape") closeLightbox();
          if (e.key === "ArrowLeft") move(-1);
          if (e.key === "ArrowRight") move(1);
        });
        document.getElementById("lightbox").addEventListener("click", (e) => {
          if (e.target === e.currentTarget) closeLightbox();
        });
      }

      // --- Helpers ---
      function escapeHtml(str) {
        return String(str || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      // --- Boot ---
      hydrate();
      bind();
      render();
    </script>
  </body>
</html>
